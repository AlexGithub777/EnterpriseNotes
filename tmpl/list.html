<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="/statics/ionicons/css/w3.css" />
        <link rel="stylesheet" href="/statics/ionicons/css/ionicons.min.css" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!--Importing jquery-->

        <title>Enterprise Notes</title>
        <style>
            .hoverbtn:hover {
                font-weight: bold;
                opacity: 0.4;
            }

            a {
                text-decoration: none;
            }
        </style>
    </head>
    <body>
      {{if .Message }}
      <!-- If there is a message to display -->
      <div class="w3-container w3-red">
          <!-- Display the message in a red-colored container -->
          <p>{{.Message}}</p>
      </div>
      {{end}}
        <div class="w3-row-padding">
            <div class="w3-card-2 w3-margin-top">
                <header class="w3-container w3-center w3-teal">
                    <div class="w3-row">
                        <div class="w3-half">
                            <h3 class="w3-right">Enterprise Notes</h3>
                        </div>
                        <div class="w3-half w3-text-right">
                            <div class="w3-right">
                                <h3 class="w3-left w3-margin-right">
                                    Logged in as {{.Username}}
                                </h3>
                                <input
                                    type="hidden"
                                    id="username"
                                    value="{{.Username}}"
                                />
                                <a
                                    href="#"
                                    onclick="document.getElementById('create-form').style.display='block'; updateDelegationDropdownCreate(); handleNoteTypeChange();"
                                >
                                    <i
                                        class="ion ion-ios-plus-outline w3-xxlarge hoverbtn"
                                    ></i>
                                </a>
                                <a href="/user-logout">
                                    <i
                                        class="ion ion-log-out w3-xxlarge hoverbtn"
                                    ></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </header>
                <h3>Search Notes</h3>
                <form class="w3-container" action="/search" method="post">
                    <input
                        class="w3-input"
                        type="text"
                        name="searchQuery"
                        placeholder="Search notes..."
                    />
                    <button class="w3-btn w3-teal" type="submit">Search</button>
                </form>
                <h3>My notes</h3>
                <table
                    class="w3-table w3-centered w3-border w3-bordered w3-hoverable"
                >
                    <thead>
                        <tr>
                            <th>Owner</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Created</th>
                            <th>Completion Time</th>
                            <th>Completion Date</th>
                            <th>Status</th>
                            <th>Delegation</th>
                            <th>Shared Users</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range $index, $note := .Notes}}
                        <tr>
                            <td>{{$note.Owner}}</td>
                            <td>{{$note.Title}}</td>
                            <td>{{$note.NoteType}}</td>
                            <td>{{$note.Description}}</td>
                            <td>
                                {{if $note.NoteCreated.IsZero}}
                                    N/A
                                {{else}}
                                    {{$note.NoteCreated.Format "02/01/2006 3:04 PM"}}
                                {{end}}
                            </td>                                                    
                            <td>
                                {{if $note.TaskCompletionTime.Valid}}
                                    {{if ne $note.TaskCompletionTime.String ""}}
                                        {{formatTime "15:04" $note.TaskCompletionTime.String}}
                                    {{else}}
                                        N/A
                                    {{end}}
                                {{else}}
                                    N/A
                                {{end}}
                            </td>                            
                            <td>
                                {{if $note.TaskCompletionDate.Valid}}
                                    {{if ne $note.TaskCompletionDate.String ""}}
                                        {{formatDate "2006-01-02" $note.TaskCompletionDate.String}}
                                    {{else}}
                                        N/A
                                    {{end}}
                                {{else}}
                                    N/A
                                {{end}}
                            </td>                                                                                
                            <td>
                                {{if $note.NoteStatus.Valid}}
                                {{$note.NoteStatus.String}} {{else}} N/A {{end}}
                            </td>
                            <td>
                                {{if $note.NoteDelegation.Valid}}
                                {{$note.NoteDelegation.String}} {{else}} N/A
                                {{end}}
                            </td>
                            <td>
                                <!-- Display the list of shared users for this note -->
                                {{range $index, $sharedUser := $note.SharedUsers}}
                                    {{if $index}}
                                        , {{$sharedUser.Username.String}}
                                    {{else}}
                                        {{$sharedUser.Username.String}}
                                    {{end}}
                                {{end}}
                            </td>
                            <td>
                                <button
                                    class="w3-btn w3-green"
                                    onclick="openFindModal(this);"
                                    find-noteID="{{$note.ID}}"
                                >
                                    Find
                                </button>
                                {{if eq $note.Owner $.Username}}
                                <!-- If the note is owned by the current user, show the normal "Modify" button -->
                                <button
                                    class="w3-btn w3-teal"
                                    onclick="updateTask(this);"
                                    data-noteid="{{$note.ID}}"
                                    data-title="{{$note.Title}}"
                                    data-description="{{$note.Description}}"
                                    data-notetype="{{$note.NoteType}}"
                                    data-completiontime="{{$note.TaskCompletionTime.String}}"
                                    data-completiondate="{{$note.TaskCompletionDate.String}}"
                                    data-notestatus="{{$note.NoteStatus.String}}"
                                    data-delegation="{{$note.NoteDelegation.String}}"
                                >
                                    Modify
                                </button>
                                {{else if eq $note.NoteDelegation.String
                                $.Username}}
                                <!-- If the note is delegated to the current user, show the "Modify Delegated" button -->
                                <button
                                    class="w3-btn w3-teal"
                                    onclick="updateDelegatedTask(this);"
                                    data-noteid="{{$note.ID}}"
                                    data-title="{{$note.Title}}"
                                    data-description="{{$note.Description}}"
                                    data-notetype="{{$note.NoteType}}"
                                    data-completiontime="{{$note.TaskCompletionTime.String}}"
                                    data-completiondate="{{$note.TaskCompletionDate.String}}"
                                    data-notestatus="{{$note.NoteStatus.String}}"
                                    data-delegation="{{$note.NoteDelegation.String}}"
                                >
                                    Modify
                                </button>
                                {{end}} {{if eq $note.Owner $.Username}}
                                <button
                                    class="w3-btn w3-blue"
                                    onclick="openOptions(this);"
                                    data-noteid="{{$note.ID}}"
                                >
                                    Share
                                </button>
                                <button
                                    class="w3-btn w3-red"
                                    onclick="deleteTask(this);"
                                    data-taskid="{{$note.ID}}"
                                >
                                    Delete
                                </button>
                                {{end}} {{if not (eq $note.Owner $.Username)}}
                                <button
                                    class="w3-btn w3-red"
                                    onclick="removeDelegation(this);"
                                    data-noteid="{{$note.ID}}"
                                >
                                    Remove Delegation
                                </button>
                                {{end}}
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>

                <h3>Notes shared with me</h3>
                <table
                    class="w3-table w3-centered w3-border w3-bordered w3-hoverable"
                >
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Created</th>
                            <th>Completion Time</th>
                            <th>Completion Date</th>
                            <th>Status</th>
                            <th>Delegation</th>
                            <th>Shared from</th>
                            <!-- New header for shared from -->
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range $index, $note := .SharedNotes}}
                        <tr>
                            <td>{{$note.Title}}</td>
                            <td>{{$note.NoteType}}</td>
                            <td>{{$note.Description}}</td>
                            <td>
                                {{if $note.NoteCreated.IsZero}}
                                    N/A
                                {{else}}
                                    {{$note.NoteCreated.Format "02/01/2006 3:04 PM"}}
                                {{end}}
                            </td>                                                      
                            <td>
                                {{if $note.TaskCompletionTime.Valid}}
                                    {{if ne $note.TaskCompletionTime.String ""}}
                                        {{formatTime "15:04" $note.TaskCompletionTime.String}}
                                    {{else}}
                                        N/A
                                    {{end}}
                                {{else}}
                                    N/A
                                {{end}}
                            </td>                            
                            <td>
                                {{if $note.TaskCompletionDate.Valid}}
                                    {{if ne $note.TaskCompletionDate.String ""}}
                                        {{formatDate "2006-01-02" $note.TaskCompletionDate.String}}
                                    {{else}}
                                        N/A
                                    {{end}}
                                {{else}}
                                    N/A
                                {{end}}
                            </td>   
                            <td>
                                {{if $note.NoteStatus.Valid}}
                                {{$note.NoteStatus.String}} {{else}} N/A
                                {{end}}
                            </td>
                            <td>
                                {{if $note.NoteDelegation.Valid}}
                                {{$note.NoteDelegation.String}} {{else}} N/A
                                {{end}}
                            </td>
                            <td>{{$note.Owner}}</td>
                            <td>
                                {{if eq $note.Privileges "editor"}}
                                <button
                                    class="w3-btn w3-teal"
                                    onclick="updateTask(this);"
                                    data-noteid="{{$note.ID}}"
                                    data-title="{{$note.Title}}"
                                    data-description="{{$note.Description}}"
                                    data-notetype="{{$note.NoteType}}"
                                    data-completiontime="{{$note.TaskCompletionTime.String}}"
                                    data-completiondate="{{$note.TaskCompletionDate.String}}"
                                    data-notestatus="{{$note.NoteStatus.String}}"
                                    data-delegation="{{$note.NoteDelegation.String}}"
                                >
                                    Modify
                                </button>
                                {{end}}

                                <button
                                    class="w3-btn w3-red"
                                    onclick="openRemoveModal('{{$note.ID}}');"
                                >
                                    Remove
                                </button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Create Modals -->
        <div class="w3-container">
            <div id="create-form" class="w3-modal">
                <div
                    class="w3-modal-content w3-card-8 w3-animate-zoom"
                    style="max-width: 600px"
                >
                    <div class="w3-container w3-teal">
                        <h2>Create a New Task</h2>
                        <span
                            class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                            onclick="document.getElementById('create-form').style.display='none'"
                            >&times;</span
                        >
                    </div>

                    <form class="w3-container" action="/create" method="post">
                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <label class="w3-label">Title</label>
                                <!--Length also validated on backend, input element breaks when excessive characters are inserted -->
                                <input
                                    class="w3-input"
                                    type="text"
                                    name="Title"
                                    id="Title"
                                    maxlength="60"
                                    required
                                />
                            </div>
                            <div class="w3-half">
                                <label class="w3-label">Type</label>
                                <select
                                    class="w3-select"
                                    name="NoteType"
                                    id="NoteType"
                                    onchange="handleNoteTypeChange();"
                                    required
                                >
                                    <option value="Note" selected>Note</option>
                                    <option value="Task">Task</option>
                                </select>
                            </div>
                        </div>
                        <div class="w3-row-padding" id="TaskCompletionTime">
                            <div class="w3-half">
                                <label class="w3-label">Completion Time</label>
                                <input
                                    class="w3-input"
                                    type="time"
                                    name="TaskCompletionTime"
                                />
                            </div>
                            <div class="w3-half" id="TaskCompletionDate">
                                <label class="w3-label">Completion Date</label>
                                <input
                                    class="w3-input"
                                    type="date"
                                    name="TaskCompletionDate"
                                />
                            </div>
                        </div>

                        <label class="w3-label">Description</label>
                        <textarea
                            class="w3-input"
                            name="Description"
                            id="Description"
                            required
                        ></textarea>

                        <label class="w3-label">Status</label>
                        <select
                            id="NoteStatus"
                            class="w3-select"
                            name="NoteStatus"
                            onchange="updateDelegationDropdownCreate()"
                            required
                        >
                            <option value="None" selected>None</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Delegated">Delegated</option>
                        </select>
                        <label class="w3-label">Delegation</label>
                        <select
                            class="w3-input"
                            type="text"
                            name="NoteDelegation"
                            id="NoteDelegation"
                        >
                            <option value="" selected></option>
                            <!-- Generate options from user data -->
                            {{range $user := .AllUsers}}
                            <option value="{{$user.Username}}">
                                {{$user.Username}}
                            </option>
                            {{end}}
                        </select>
                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <button
                                    class="w3-btn w3-teal w3-margin-top w3-margin-bottom"
                                    type="submit"
                                >
                                    Create
                                </button>
                            </div>
                            <div class="w3-half">
                                <button
                                    class="w3-btn w3-red w3-margin-top w3-margin-bottom w3-right"
                                    type="button"
                                    onclick="document.getElementById('create-form').style.display='none'"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="w3-container">
            <div id="edit-form" class="w3-modal">
                <div
                    class="w3-modal-content w3-card-8 w3-animate-zoom"
                    style="max-width: 600px"
                >
                    <div class="w3-container w3-teal">
                        <h2>Edit Task</h2>
                        <span
                            class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                            onclick="document.getElementById('edit-form').style.display='none';"
                        >
                            &times;
                        </span>
                    </div>

                    <form class="w3-container" action="/update" method="post">
                        <input type="hidden" name="Id" id="taskIdToUpdate" />

                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <label class="w3-label">Title</label>
                                <!--Length also validated on backend, input element breaks when excessive characters are inserted -->
                                <input
                                    class="w3-input"
                                    type="text"
                                    id="editTitle"
                                    name="Title"
                                    maxlength="60"
                                    required
                                />
                            </div>

                            <div class="w3-half">
                                <label class="w3-label">Note/Task</label>
                                <select
                                    class="w3-select"
                                    id="editNoteType"
                                    name="NoteType"
                                    onchange="editHandleNoteTypeChange()"
                                    required
                                >
                                    <option value="Note">Note</option>
                                    <option value="Task">Task</option>
                                </select>
                            </div>
                        </div>

                        <div class="w3-row-padding">
                            <div class="w3-half" id="editTaskCompletionTimeDiv">
                                <label class="w3-label">Completion Time</label>
                                <input
                                    class="w3-input"
                                    type="time"
                                    id="editTaskCompletionTime"
                                    name="TaskCompletionTime"
                                />
                            </div>

                            <div class="w3-half" id="editTaskCompletionDateDiv">
                                <label class="w3-label">Completion Date</label>
                                <input
                                    class="w3-input"
                                    type="date"
                                    id="editTaskCompletionDate"
                                    name="TaskCompletionDate"
                                />
                            </div>
                        </div>

                        <label class="w3-label">Description</label>
                        <textarea
                            class="w3-input"
                            name="Description"
                            id="editDescription"
                            required
                        ></textarea>

                        <label class="w3-label">Status</label>
                        <select
                            class="w3-input"
                            id="editNoteStatus"
                            name="NoteStatus"
                            onchange="updateDelegationDropdown();"
                        >
                            <option value="None">None</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Delegated">Delegated</option>
                        </select>

                        <label class="w3-label">Delegation</label>

                        <select
                            class="w3-input"
                            id="editNoteDelegation"
                            name="NoteDelegation"
                        >
                            <!-- Generate options from user data -->
                            {{range $user := .AllUsers}}
                            <option value="{{$user.Username}}">
                                {{$user.Username}}
                            </option>
                            {{end}}
                        </select>

                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <button
                                    class="w3-btn w3-teal w3-margin-top w3-margin-bottom"
                                    type="submit"
                                >
                                    Save
                                </button>
                            </div>
                            <div class="w3-half">
                                <button
                                    class="w3-btn w3-red w3-margin-top w3-margin-bottom w3-right"
                                    type="button"
                                    onclick="document.getElementById('edit-form').style.display='none'"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Delegated Form Modal -->
        <div class="w3-container">
            <div id="edit-delegated-form" class="w3-modal">
                <div
                    class="w3-modal-content w3-card-8 w3-animate-zoom"
                    style="max-width: 600px"
                >
                    <div class="w3-container w3-teal">
                        <h2>Edit Delegated Task</h2>
                        <span
                            class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                            onclick="document.getElementById('edit-delegated-form').style.display='none';"
                            >&times;</span
                        >
                    </div>
                    <form class="w3-container" action="/update" method="post">
                        <input
                            type="hidden"
                            name="Id"
                            id="delegatedTaskIdToUpdate"
                        />
                        <input
                            type="hidden"
                            name="NoteDelegation"
                            id="updateDelegatedNote"
                        />

                        <div class="w3-row-padding">
                            <label class="w3-label">Title</label>
                            <!--Length also validated on backend, input element breaks when excessive characters are inserted -->
                            <input
                                class="w3-input"
                                type="text"
                                id="DelegatedTitle"
                                name="Title"
                                maxlength="60"
                                required
                            />
                        </div>
                        <input
                            id="DelegatedNoteType"
                            name="NoteType"
                            style="display: none"
                        />
                        <input
                            id="DelegatedTaskCompletionTime"
                            name="TaskCompletionTime"
                            style="display: none"
                        />
                        <input
                            id="DelegatedTaskCompletionDate"
                            name="TaskCompletionDate"
                            style="display: none"
                        />

                        <label class="w3-label">Description</label>
                        <textarea
                            class="w3-input"
                            name="Description"
                            id="DelegatedDescription"
                            required
                        ></textarea>

                        <!--Hide note status in edit-delegated as status should always be delegated, and only owner should be able to set-->
                        <input
                            id="DelegatedNoteStatus"
                            name="NoteStatus"
                            style="display: none"
                        />

                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <button
                                    class="w3-btn w3-teal w3-margin-top w3-margin-bottom"
                                    type="submit"
                                >
                                    Save
                                </button>
                            </div>
                            <div class="w3-half">
                                <button
                                    class="w3-btn w3-red w3-margin-top w3-margin-bottom w3-right"
                                    type="button"
                                    onclick="document.getElementById('edit-delegated-form').style.display='none'"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Modals -->
        <div class="w3-container">
            <div id="delete-form" class="w3-modal">
                <div
                    class="w3-modal-content w3-card-8 w3-animate-zoom"
                    style="max-width: 600px"
                >
                    <div class="w3-container w3-teal">
                        <h2>Are you sure?</h2>
                        <span
                            class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                            onclick="document.getElementById('delete-form').style.display='none'"
                            >&times;</span
                        >
                    </div>

                    <form class="w3-container" action="/delete" method="post">
                        <input type="hidden" name="Id" id="taskIdToDelete" />
                        <div class="w3-center">
                            <button
                                class="w3-btn w3-red w3-margin-top w3-margin-bottom"
                                type="submit"
                            >
                                Delete
                            </button>
                            <button
                                type="button"
                                class="w3-btn w3-teal w3-margin-top w3-margin-bottom"
                                onclick="document.getElementById('delete-form').style.display='none'"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Options Modal -->
        <div id="options-modal" class="w3-modal">
            <div
                class="w3-modal-content w3-card-8 w3-animate-zoom"
                style="max-width: 600px"
            >
                <div class="w3-container w3-teal">
                    <h2>Share</h2>
                    <span
                        class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                        onclick="closeOptionsModal()"
                        >&times;</span
                    >
                </div>

                <!-- Shared Users Table -->
                <h4 style="margin-left: 10px">Shared Users</h4>

                <table
                    class="w3-table w3-centered w3-border w3-bordered w3-hoverable"
                >
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Editor</th>
                            <th>Viewer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sharedUsersTable">
                        <!-- Shared users will be dynamically added here using JavaScript -->
                    </tbody>
                </table>

                <h4 style="margin-left: 10px">Share note</h4>
                <!-- Share Form -->
                <form class="w3-container" action="/share" method="post">
                    <input type="hidden" id="taskIdToShare" name="Id" />

                    <label class="w3-label">Select User</label>
                    <select
                        class="w3-select"
                        name="SharedUsername"
                        required
                        id="userDropdown"
                    >
                        <!-- Options will be populated using JavaScript -->
                    </select>

                    <label class="w3-label">Privileges</label>
                    <div class="w3-container">
                        <input
                            class="w3-radio"
                            type="radio"
                            name="Privileges"
                            value="editor"
                            checked
                        />
                        <label class="w3-validate">Editor</label>

                        <input
                            class="w3-radio"
                            type="radio"
                            name="Privileges"
                            value="viewer"
                        />
                        <label class="w3-validate">Viewer</label>
                    </div>

                    <button class="w3-btn w3-teal w3-margin-top" type="submit">
                        Share
                    </button>
                </form>
            </div>
        </div>

        <!--Remove share modal-->
        <div class="w3-container">
            <div id="remove-form" class="w3-modal">
                <div
                    class="w3-modal-content w3-card-8 w3-animate-zoom"
                    style="max-width: 600px"
                >
                    <div class="w3-container w3-teal">
                        <h2>Are you sure?</h2>
                        <span
                            class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                            onclick="document.getElementById('remove-form').style.display='none'"
                            >&times;</span
                        >
                    </div>

                    <form
                        class="w3-container"
                        action="/remove-shared-note"
                        method="post"
                    >
                        <input
                            type="hidden"
                            name="noteID"
                            id="noteIdToRemove"
                        />

                        <input
                            type="hidden"
                            name="username"
                            id="usernameToRemove"
                        />
                        <div class="w3-center">
                            <button
                                class="w3-btn w3-red w3-margin-top w3-margin-bottom"
                                type="submit"
                            >
                                Remove
                            </button>
                            <button
                                type="button"
                                class="w3-btn w3-teal w3-margin-top w3-margin-bottom"
                                onclick="document.getElementById('remove-form').style.display='none'"
                            >
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Apply Privilege Changes Modal -->
        <div id="applyPrivilegeModal" class="w3-modal">
            <div
                class="w3-modal-content w3-card-8 w3-animate-zoom"
                style="max-width: 400px"
            >
                <div class="w3-container w3-teal">
                    <h2>Apply Privilege Changes</h2>
                    <span
                        class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                        onclick="closeApplyPrivilegeModal()"
                        >&times;</span
                    >
                </div>
                <!-- Privilege Changes Form -->
                <form
                    class="w3-container"
                    action="/update-privileges"
                    method="post"
                >
                    <!-- Hidden fields to store noteID and privileges -->
                    <input
                        type="hidden"
                        id="usernametoUpdate"
                        name="username"
                    />
                    <input type="hidden" id="noteIdToUpdate" name="noteID" />
                    <input
                        type="hidden"
                        id="updatedPrivileges"
                        name="privileges"
                    />
                    <button class="w3-btn w3-teal w3-margin-top" type="submit">
                        Apply
                    </button>
                </form>
            </div>
        </div>

        <!-- Find modal -->
        <div id="find-form" class="w3-modal">
            <div
                class="w3-modal-content w3-card-8 w3-animate-zoom"
                style="max-width: 600px"
            >
                <div class="w3-container w3-teal">
                    <h2>Find Text</h2>
                    <span
                        class="w3-closebtn w3-hover-red w3-container w3-padding-8 w3-display-topright"
                        onclick="closeFindModal();"
                        >&times;</span
                    >
                </div>

                <!-- Modal Content -->
                <div class="w3-container">
                    <input type="hidden" name="noteId" id="findNoteId" />
                    <input
                        type="text"
                        id="searchInput"
                        name="searchInput"
                        class="w3-input"
                        placeholder="Enter text to find"
                    />
                    <button class="w3-btn w3-blue" onclick="findText();">
                        Find
                    </button>

                    <p id="searchResults">Results will appear here.</p>
                </div>
            </div>
        </div>

        <script>
            function updateDelegatedTask(e) {
                var editDelegatedForm = document.getElementById(
                    "edit-delegated-form"
                );
                // Display the "Edit Delegated Modal"
                editDelegatedForm.style.display = "block";

                // Get the data attributes from the button element
                var id = e.getAttribute("data-noteid");
                var title = e.getAttribute("data-title");
                var description = e.getAttribute("data-description");
                var type = e.getAttribute("data-notetype");
                var completionTime = e.getAttribute("data-completiontime");
                var completionDate = e.getAttribute("data-completiondate");
                var status = e.getAttribute("data-notestatus");
                var delegation = e.getAttribute("data-delegation");

                console.log("Completion Time:", completionTime);
                console.log("Completion Date:", completionDate);

                // Populate the "Edit Delegated Modal" fields with the data
                document.getElementById("delegatedTaskIdToUpdate").value = id;
                document.getElementById("DelegatedTitle").value = title;
                // Set other fields as needed (type, completionTime, completionDate, status, delegation)
                document.getElementById("DelegatedNoteType").value = type;
                // Convert completionTime from "02:00 PM" to "14:00"

                document.getElementById("DelegatedDescription").value =
                    description;
                document.getElementById("DelegatedNoteStatus").value = status;
                document.getElementById("updateDelegatedNote").value =
                    delegation;
                document.getElementById("DelegatedTaskCompletionDate").value =
                    completionDate;
                document.getElementById("DelegatedTaskCompletionTime").value =
                    completionTime;

                DelegatedHandleNoteTypeChange();
            }

            function updateTask(e) {
                var editForm = document.getElementById("edit-form");
                // Display update form
                editForm.style.display = "block";

                var id = e.getAttribute("data-noteid");
                var title = e.getAttribute("data-title");
                var description = e.getAttribute("data-description");
                var type = e.getAttribute("data-notetype");
                var completionTime = e.getAttribute("data-completiontime");
                var completionDate = e.getAttribute("data-completiondate");
                var status = e.getAttribute("data-notestatus");
                var delegation = e.getAttribute("data-delegation");

                // Populate the edit form fields with the note data
                document.getElementById("editTitle").value = title;
                document.getElementById("editNoteType").value = type;
                document.getElementById("editDescription").value = description;
                document.getElementById("editNoteStatus").value = status;
                document.getElementById("editNoteDelegation").value =
                    delegation;
                document.getElementById("editTaskCompletionDate").value =
                    completionDate;
                document.getElementById("editTaskCompletionTime").value =
                    completionTime;
                // Get task ID to update

                var taskId = e.getAttribute("data-noteid");
                document.getElementById("taskIdToUpdate").value = taskId;
                // Call the updateDelegationDropdown function to enable or disable the delegation dropdown based on the note status
                updateDelegationDropdown();
                editHandleNoteTypeChange();
            }

            function deleteTask(e) {
                var deleteForm = document.getElementById("delete-form");
                deleteForm.style.display = "block";

                // Get task ID to delete from the data attribute
                var taskId = e.getAttribute("data-taskid");

                // Assuming taskId is a string, you can convert it to an integer using parseInt
                var noteID = parseInt(taskId, 10);

                document.getElementById("taskIdToDelete").value = noteID;
            }

            function shareTask(e) {
                var shareForm = document.getElementById("share-form");
                shareForm.style.display = "block";

                // Get task ID to delete from the data attribute
                var taskId = e.getAttribute("data-noteid");

                // Assuming taskId is a string, you can convert it to an integer using parseInt
                var noteID = parseInt(taskId, 10);

                document.getElementById("taskIdToShare").value = noteID;
            }

            function openRemoveModal(noteID) {
                document.getElementById("remove-form").style.display = "block";
                document.getElementById("noteIdToRemove").value = noteID;
                var username = document.getElementById("username").value;
                document.getElementById("usernameToRemove").value = username;
            }

            function openOptions(button) {
                var noteId = button.getAttribute("data-noteid");
                document.getElementById("taskIdToShare").value = noteId;

                // Make an AJAX request to retrieve note details
                $.ajax({
                    url: "/getSharedUsersForNote/" + noteId, // Updated endpoint
                    method: "GET",
                    dataType: "json",
                    success: function (data) {
                        // Sort the shared users array by username
                        data.sort(function (a, b) {
                            var usernameA = a.Username.String.toLowerCase();
                            var usernameB = b.Username.String.toLowerCase();
                            return usernameA.localeCompare(usernameB);
                        });
                        // Populate the modal with shared users' data
                        // For example:
                        var sharedUsersTable =
                            document.getElementById("sharedUsersTable");
                        sharedUsersTable.innerHTML = ""; // Clear existing content

                        for (var i = 0; i < data.length; i++) {
                            var user = data[i];
                            var row = sharedUsersTable.insertRow(
                                sharedUsersTable.rows.length
                            );

                            var usernameCell = row.insertCell(0);
                            usernameCell.innerHTML =
                                "<span id=usernametoTake>" +
                                user.Username.String +
                                "</span>"; // Populate username

                            var editorRadio = row
                                .insertCell(1)
                                .appendChild(document.createElement("input"));
                            editorRadio.id =
                                "editorRadio_" + user.Username.String;
                            editorRadio.type = "radio";
                            editorRadio.name =
                                "updatedPrivileges_" + user.Username.String;
                            editorRadio.value = "editor";
                            editorRadio.checked =
                                user.Privileges.String === "editor";

                            var viewerRadio = row
                                .insertCell(2)
                                .appendChild(document.createElement("input"));
                            viewerRadio.id =
                                "viewerRadio_" + user.Username.String;
                            viewerRadio.type = "radio";
                            viewerRadio.name =
                                "updatedPrivileges_" + user.Username.String;
                            viewerRadio.value = "viewer";
                            viewerRadio.checked =
                                user.Privileges.String === "viewer";

                            var actionsCell = row.insertCell(3);
                            actionsCell.innerHTML =
                                '<button class="w3-btn w3-red" onclick="stopSharing(this)" data-username="' +
                                user.Username.String +
                                '" data-noteid="' +
                                noteId +
                                '">Stop Sharing</button>' +
                                '<button class="w3-btn w3-teal" onclick="openApplyPrivilegeModal(' +
                                noteId +
                                ", '" +
                                user.Username.String +
                                "', '" +
                                user.Privileges.String +
                                "')\">Apply Changes</button>";

                            // Populate Actions button
                        }
                    },
                    error: function (error) {
                        console.log("Failed to fetch shared users: " + error);
                    },
                });

                // Use AJAX to retrieve the list of unshared users
                $.ajax({
                    url: "/getUnsharedUsersForNote/" + noteId, // Replace with your server endpoint
                    method: "GET",
                    dataType: "json",
                    success: function (data) {
                        console.log("Received data:", data); // Log the data

                        // Populate the dropdown with unshared users
                        var userDropdown =
                            document.getElementById("userDropdown");
                        userDropdown.innerHTML = ""; // Clear existing options

                        if (data && data.length > 0) {
                            for (var i = 0; i < data.length; i++) {
                                var user = data[i];
                                console.log(
                                    "Username[" + i + "]:",
                                    user.username
                                ); // Log the username

                                var option = document.createElement("option");
                                option.value = user.username;
                                option.text = user.username;
                                userDropdown.appendChild(option);
                            }
                        } else {
                            console.error("No data received or data is empty");
                        }
                    },
                    error: function (error) {
                        console.error(
                            "Failed to fetch unshared users: " + error
                        );
                    },
                });

                document.getElementById("options-modal").style.display =
                    "block";
            }

            function closeOptionsModal() {
                document.getElementById("options-modal").style.display = "none";
            }

            function stopSharing(button) {
                // Retrieve the username and note ID from the button's data attributes
                var username = button.getAttribute("data-username");
                var noteId = button.getAttribute("data-noteid");

                // Store the username and note ID in the modal form
                document.getElementById("noteIdToRemove").value = noteId;

                document.getElementById("usernameToRemove").value = username;

                // Display the "Remove share" modal
                document.getElementById("remove-form").style.display = "block";
            }

            function updatePrivileges() {
                var selectedUsername =
                    document.getElementById("selectedUsername").value;
                var selectedPrivileges = document.querySelector(
                    'input[name="updatedPrivileges_' +
                        selectedUsername +
                        '"]:checked'
                );

                if (selectedPrivileges) {
                    var updatedPrivileges = selectedPrivileges.value;

                    // Set the values of the hidden fields in the form
                    document.getElementById("usernametoUpdate").value =
                        selectedUsername;
                    document.getElementById("updatedPrivileges").value =
                        updatedPrivileges;

                    // Make an AJAX request to update the privileges
                    $.ajax({
                        url: "/update-privileges",
                        method: "POST",
                        data: {
                            username: selectedUsername,
                            privileges: updatedPrivileges,
                        },
                        success: function (data) {
                            // Handle success (e.g., show a success message)
                            alert("Privileges updated successfully");
                        },
                        error: function (error) {
                            // Handle errors (e.g., show an error message)
                            alert(
                                "Failed to update privileges: " +
                                    error.responseText
                            );
                        },
                    });
                } else {
                    alert("Please select a privilege.");
                }
            }

            function openApplyPrivilegeModal(noteID, username) {
                var noteId = noteID;

                // Determine privileges based on the selected radio button
                var editorRadio = document.getElementById(
                    "editorRadio_" + username
                );
                var viewerRadio = document.getElementById(
                    "viewerRadio_" + username
                );

                var privileges = "";
                if (editorRadio.checked) {
                    privileges = "editor";
                } else if (viewerRadio.checked) {
                    privileges = "viewer";
                }

                // Set the values of the hidden fields in the Apply Privilege modal form
                document.getElementById("noteIdToUpdate").value = noteId;
                document.getElementById("updatedPrivileges").value = privileges;
                document.getElementById("usernametoUpdate").value = username;

                // Open Apply Privilege Changes modal
                document.getElementById("applyPrivilegeModal").style.display =
                    "block";
            }

            function closeApplyPrivilegeModal() {
                // Close the Apply Privilege Changes modal
                document.getElementById("applyPrivilegeModal").style.display =
                    "none";
            }

            function openFindModal(button) {
                var noteId = button.getAttribute("find-noteID");
                document.getElementById("findNoteId").value = noteId;
                document.getElementById("find-form").style.display = "block";
            }

            function closeFindModal() {
                document.getElementById("find-form").style.display = "none";
            }
            function findText() {
                var searchText = document.getElementById("searchInput").value;
                var noteId = document.getElementById("findNoteId").value;

                // Clear previous search results
                document.getElementById("searchResults").textContent = "";

                // Example logic: You can search for the text in your notes' content and update the "searchResults" with the search results.
                findTextInNotes(searchText, noteId);
            }
            // disables delegation dropdown when note status is != delegated in edit modal
            function updateDelegationDropdown() {
                var status = document.getElementById("editNoteStatus").value;
                var delegationDropdown =
                    document.getElementById("editNoteDelegation");

                if (status === "Delegated") {
                    delegationDropdown.disabled = false;
                } else {
                    delegationDropdown.disabled = true;
                    delegationDropdown.value = ""; // Clear the value of the delegation dropdown
                }
            }

            function updateDelegationDropdownCreate() {
                var status = document.getElementById("NoteStatus").value;
                var delegationDropdown =
                    document.getElementById("NoteDelegation");

                if (status === "Delegated") {
                    delegationDropdown.disabled = false;
                } else {
                    delegationDropdown.disabled = true;
                    delegationDropdown.value = ""; // Clear the value of the delegation dropdown
                }
            }

            // Function to handle note type change FOR CREATE MODAL
            function handleNoteTypeChange() {
                var noteType = document.getElementById("NoteType").value;
                var completionTimeField =
                    document.getElementById("TaskCompletionTime");
                var completionDateField =
                    document.getElementById("TaskCompletionDate");

                if (noteType === "Task") {
                    completionTimeField.style.display = "block";
                    completionDateField.style.display = "block";
                } else {
                    completionTimeField.style.display = "none";
                    completionDateField.style.display = "none";
                    // Set the value to an empty string if not a task
                    completionTimeField.value = "";
                    completionDateField.value = "";
                }
            }

            // Function to handle note type change FOR EDIT MODAL
            function editHandleNoteTypeChange() {
                var noteType = document.getElementById("editNoteType").value;
                var completionTimeFieldDiv = document.getElementById(
                    "editTaskCompletionTimeDiv"
                );
                var completionDateFieldDiv = document.getElementById(
                    "editTaskCompletionDateDiv"
                );

                var completionTimeField = document.getElementById(
                    "editTaskCompletionTime"
                );
                var completionDateField = document.getElementById(
                    "editTaskCompletionDate"
                );

                if (noteType === "Task") {
                    completionTimeFieldDiv.style.display = "block";
                    completionDateFieldDiv.style.display = "block";
                } else {
                    completionTimeFieldDiv.style.display = "none";
                    completionDateFieldDiv.style.display = "none";
                    // Set the value to an empty string if not a task
                    completionTimeField.value = "";
                    completionDateField.value = "";
                }
            }

            // Function to handle note type change FOR EDIT MODAL
            function DelegatedHandleNoteTypeChange() {
                var noteType =
                    document.getElementById("DelegatedNoteType").value;
                var completionTimeFieldDiv = document.getElementById(
                    "DelegatedTaskCompletionTimeDiv"
                );
                var completionDateFieldDiv = document.getElementById(
                    "DelegatedTaskCompletionDateDiv"
                );

                var completionTimeField = document.getElementById(
                    "DelegatedTaskCompletionTime"
                );
                var completionDateField = document.getElementById(
                    "DelegatedTaskCompletionDate"
                );

                if (noteType === "Task") {
                    completionTimeFieldDiv.style.display = "block";
                    completionDateFieldDiv.style.display = "block";
                } else {
                    completionTimeFieldDiv.style.display = "none";
                    completionDateFieldDiv.style.display = "none";
                    // Set the value to an empty string if not a task
                    completionTimeField.value = "";
                    completionDateField.value = "";
                }
            }

            function removeDelegation(button) {
                // Assuming 'button' is the button element that was clicked
                var noteID = button.getAttribute("data-noteid");

                
                // Make an AJAX request to remove delegation
                $.ajax({
                    url: "/remove-delegation/" + noteID,
                    method: "POST",
                    contentType: "application/json",
                    success: function (response) {
                        // Handle success
                        alert("Delegation removed successfully.");

                        // Refresh the page
                        location.reload();
                    },
                    error: function (error) {
                        // Handle errors or display an error message
                        alert("Error: Unable to remove delegation.");
                    }
                });

            }

            function findTextInNotes(searchText, noteId) {
                // Use AJAX to find text in a note with a GET request
                $.ajax({
                    url: "/find/" + noteId,
                    method: "GET",
                    data: { searchInput: searchText },
                    dataType: "json",
                    success: function (data) {
                        console.log("Received search results:", data);

                        var totalCount = 0; // Initialize the total count variable
                        var exceeds50CharactersMessage = ""; // Initialize the message

                        for (var i = 0; i < data.length; i++) {
                            var result = data[i];
                            var count = result.Count; // Parse the count as an integer
                            totalCount += count; // Update the total count

                            if (result.Description === "Find Error: Search query exceeds 50 characters") {
                                exceeds50CharactersMessage = result.Description;
                            }
                        }

                        // Check if exceeds50CharactersMessage is set and display accordingly
                        if (exceeds50CharactersMessage) {
                            document.getElementById("searchResults").textContent = exceeds50CharactersMessage;
                        } else if (totalCount > 0) {
                            // Display the total count if it exists
                            var searchResults = "Total occurrences in the note: " + totalCount;
                            document.getElementById("searchResults").textContent = searchResults;
                        } else {
                            // Display a message when no results are found
                            document.getElementById("searchResults").textContent = "No matching results found";
                        }
                    },
                    error: function (error) {
                        console.error("Failed to perform the search: " + error);
                    },
                });
            }
        </script>
    </body>
</html>
